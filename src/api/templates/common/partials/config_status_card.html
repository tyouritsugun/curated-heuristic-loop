{% set config_status = env_config_status %}
<section
  id="config-status-card"
  class="card"
  hx-get="/ui/settings/config-status"
  hx-trigger="ops-refresh from:body, every 5s"
  hx-target="this"
  hx-swap="outerHTML"
>
  <header>
    <div>
      <h2>Configuration Status</h2>
      <p class="muted">Configuration is managed via <code>.env</code> file. Changes take effect immediately without restart.</p>
      {% if skills_enabled is not none and not skills_enabled %}
        <p class="muted" style="margin-top: 0.5rem;">
          <strong>Skills are disabled.</strong> Skill read/write/import/export are hidden or skipped.
        </p>
      {% endif %}
    </div>
    <span class="status-pill {{ config_status.state }}">{{ config_status.headline }}</span>
  </header>

  <div class="config-status-grid">
    <div class="config-section">
      {% set import_summary = ((job_summaries or {}).get('import') or {}) %}
      {% set import_active = import_summary.get('is_active', False) %}
      <div class="section-header">
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding-right: 0.5rem; width: 50%;">
              <form id="import-sheet-form" hx-post="/ui/operations/run/import" hx-target="#config-status-card" hx-swap="outerHTML" style="margin: 0;">
                <input type="hidden" name="payload" id="import-sheet-payload" />
                <button type="submit" class="section-title-button" style="width: 90%;" onclick="handleSheetImportClick(event)" {% if import_active %}disabled{% endif %}>
              <form id="import-sheet-form" hx-post="/ui/operations/run/import" hx-target="#config-status-card" hx-swap="outerHTML" style="margin: 0;">
                <input type="hidden" name="payload" id="import-sheet-payload" />
                <button type="submit" class="section-title-button" style="width: 90%;" onclick="handleSheetImportClick(event)" {% if import_active %}disabled{% endif %}>
                  {% if import_active %}
                    Import Spreadsheet (Importing...)
                  {% else %}
                    Import Spreadsheet
                  {% endif %}
                </button>
              </form>
            </td>
            <td style="padding-left: 0.5rem; width: 50%;">
              <form id="import-excel-form" action="/ui/operations/import-excel-upload" method="post" enctype="multipart/form-data" style="margin: 0; display: none;">
                <input type="file" name="excel_file" id="excel_file" accept=".xlsx,.xls" onchange="handleExcelFileSelect(this)" />
                <input type="hidden" name="external_skills_target" id="external_skills_target" />
                <input type="hidden" name="external_skills_target" id="external_skills_target" />
              </form>
              <button type="button" class="section-title-button" style="width: 100%;" onclick="triggerExcelFileSelect()">Import Excel</button>
            </td>
          </tr>
        </table>
      </div>
      {% if config_status.import_sheet_id %}
        {% set summary = import_summary %}
        {% if summary %}
          <div class="status-row">
            <div>
              <p class="run-label">Last Run</p>
              <p class="muted">{{ summary.description or 'Activity recorded.' }}</p>
            </div>
            <span class="status-pill {{ summary.pill_class }}" data-job-status="{{ summary.status }}">
              {{ summary.status_label }}
            </span>
          </div>
        {% else %}
          <div class="status-row">
            <span class="status-chip ok">Configured</span>
            <small class="muted">No runs yet</small>
          </div>
        {% endif %}
      {% else %}
        <div class="status-row">
          <span class="status-chip error">Not Configured</span>
          <small class="muted">Set IMPORT_SPREADSHEET_ID in .env file</small>
        </div>
      {% endif %}
    </div>

    <div class="config-section">
      {% set export_summary = ((job_summaries or {}).get('export') or {}) %}
      {% set export_active = export_summary.get('is_active', False) %}
      <div class="section-header">
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding-right: 0.5rem; width: 50%;">
              <form id="export-sheet-form" hx-post="/ui/operations/run/export" hx-target="#config-status-card" hx-swap="outerHTML" style="margin: 0;">
                <input type="hidden" name="payload" id="export-sheet-payload" />
                <button type="submit" class="section-title-button" style="width: 90%;" onclick="handleSheetExportClick(event)" {% if export_active %}disabled{% endif %}>
              <form id="export-sheet-form" hx-post="/ui/operations/run/export" hx-target="#config-status-card" hx-swap="outerHTML" style="margin: 0;">
                <input type="hidden" name="payload" id="export-sheet-payload" />
                <button type="submit" class="section-title-button" style="width: 90%;" onclick="handleSheetExportClick(event)" {% if export_active %}disabled{% endif %}>
                  {% if export_active %}
                    Export Spreadsheet (Exporting...)
                  {% else %}
                    Export Spreadsheet
                  {% endif %}
                </button>
              </form>
            </td>
            <td style="padding-left: 0.5rem; width: 50%;">
              <button type="button" class="section-title-button" style="width: 100%;" onclick="triggerExcelExportAndDownload()">Export Excel</button>
            </td>
          </tr>
        </table>
      </div>
      {% if config_status.export_sheet_id %}
        {% set summary = export_summary %}
        {% if summary %}
          <div class="status-row">
            <div>
              <p class="run-label">Last Run</p>
              <p class="muted">{{ summary.description or 'Activity recorded.' }}</p>
            </div>
            <span class="status-pill {{ summary.pill_class }}" data-job-status="{{ summary.status }}">
              {{ summary.status_label }}
            </span>
          </div>
        {% else %}
          <div class="status-row">
            <span class="status-chip ok">Configured</span>
            <small class="muted">No runs yet</small>
          </div>
        {% endif %}
      {% else %}
        <div class="status-row">
          <span class="status-chip error">Not Configured</span>
          <small class="muted">Set EXPORT_SPREADSHEET_ID in .env file</small>
        </div>
      {% endif %}
      {% if not skills_enabled %}
        <div class="status-row">
          <small class="muted">Skills export comes from external SKILLS.md folders. Choose source in the export prompt; “None” skips skills.</small>
        </div>
      {% endif %}

      <div class="section-header" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color, #e0e0e0);">
        <button type="button" class="section-title-button" style="width: 100%; cursor: pointer;" onclick="triggerCsvExportDownload()">
        <button type="button" class="section-title-button" style="width: 100%; cursor: pointer;" onclick="triggerCsvExportDownload()">
          Export CSV
        </button>
      </div>
      <div class="status-row">
        <span class="status-chip ok">Team Curation</span>
        <small class="muted">Downloads {username}_export.zip for merge workflow</small>
        <small class="muted">Downloads {username}_export.zip for merge workflow</small>
      </div>
    </div>
  </div>

  {% if not skills_enabled %}
    <div id="external-skills-modal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 1000;">
      <div style="max-width: 520px; margin: 10vh auto; background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <h3 style="margin: 0 0 0.5rem 0;">Import curated skills to external tools?</h3>
        <p class="muted" style="margin: 0 0 1rem 0;">This will overwrite existing SKILLS.md files in the selected targets.</p>
        <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
          <label><input type="radio" name="external_skills_choice" value="claude"> Claude only</label>
          <label><input type="radio" name="external_skills_choice" value="codex"> ChatGPT only</label>
          <label><input type="radio" name="external_skills_choice" value="both"> Both</label>
          <label><input type="radio" name="external_skills_choice" value="none" checked> None (skip skills)</label>
        </div>
        <label style="display:block; margin-bottom: 1rem;">
          <input type="checkbox" id="external-skills-confirm" />
          I understand this will overwrite SKILLS.md files
        </label>
        <div style="display:flex; justify-content: flex-end; gap: 0.5rem;">
          <button type="button" class="section-title-button" onclick="closeExternalSkillsModal()">Cancel</button>
          <button type="button" class="section-title-button" onclick="confirmExternalSkillsModal()">OK</button>
        </div>
      </div>
    </div>
  {% endif %}

  {% if not skills_enabled %}
    <div id="external-skills-export-modal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 1000;">
      <div style="max-width: 520px; margin: 10vh auto; background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <h3 style="margin: 0 0 0.5rem 0;">Export skills from external tools?</h3>
        <p class="muted" style="margin: 0 0 1rem 0;">Choose the source for skills. Experiences always export from CHL DB.</p>
        <div style="display: grid; gap: 0.5rem; margin-bottom: 1rem;">
          <label><input type="radio" name="external_skills_export_choice" value="claude"> Claude only</label>
          <label><input type="radio" name="external_skills_export_choice" value="chatgpt"> ChatGPT only</label>
          <label><input type="radio" name="external_skills_export_choice" value="none" checked> None (skip skills)</label>
        </div>
        <div style="display:flex; justify-content: flex-end; gap: 0.5rem;">
          <button type="button" class="section-title-button" onclick="closeExternalSkillsExportModal()">Cancel</button>
          <button type="button" class="section-title-button" onclick="confirmExternalSkillsExportModal()">OK</button>
        <div style="display:flex; justify-content: flex-end; gap: 0.5rem;">
          <button type="button" class="section-title-button" onclick="closeExternalSkillsExportModal()">Cancel</button>
          <button type="button" class="section-title-button" onclick="confirmExternalSkillsExportModal()">OK</button>
        </div>
      </div>
    </div>
  {% endif %}

  {% if is_partial and (message or error) %}
    {% with oob=True %}
      {% include "common/partials/flash.html" %}
    {% endwith %}
  {% endif %}

  <script>
    const skillsEnabled = {{ 'true' if skills_enabled else 'false' }};
    let pendingImportMode = null;
    let pendingExportMode = null;

    const skillsEnabled = {{ 'true' if skills_enabled else 'false' }};
    let pendingImportMode = null;
    let pendingExportMode = null;

    function triggerExcelFileSelect() {
      if (!skillsEnabled) {
        pendingImportMode = 'excel';
        openExternalSkillsModal();
        return;
      }
      if (!skillsEnabled) {
        pendingImportMode = 'excel';
        openExternalSkillsModal();
        return;
      }
      document.getElementById('excel_file').click();
    }

    function handleExcelImport(event) {
      event.preventDefault();
      const form = document.getElementById('import-excel-form');
      const fileInput = document.getElementById('excel_file');

      // Submit the form normally (not via HTMX since it has file upload)
      const formData = new FormData(form);

      // Debug logging
      console.log('Submitting Excel file:', fileInput.files[0] ? fileInput.files[0].name : 'No file');

      fetch(form.action, {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.text();
      })
      .then(html => {
        console.log('Received response from server, updating UI');
        // Replace the config-status-card with the updated content
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newCard = doc.querySelector('#config-status-card');
        if (newCard) {
          document.getElementById('config-status-card').outerHTML = newCard.outerHTML;
        } else {
          console.error('Could not find config-status-card in response');
        }
      })
      .catch(error => {
        console.error('Error importing Excel:', error);
        alert('Error importing Excel file: ' + error.message);
      });
    }

    function handleExcelFileSelect(inputElement) {
      if (inputElement.files.length > 0) {
        // Pass a mock event to handleExcelImport to prevent default
        const mockEvent = { preventDefault: function() {} };
        handleExcelImport(mockEvent);
      }
    }

    function openExternalSkillsModal() {
      const modal = document.getElementById('external-skills-modal');
      if (modal) {
        modal.style.display = 'block';
      }
      pauseConfigStatusRefresh(true);
    }

    function closeExternalSkillsModal() {
      const modal = document.getElementById('external-skills-modal');
      if (modal) {
        modal.style.display = 'none';
      }
      pendingImportMode = null;
      pauseConfigStatusRefresh(false);
    }

    function confirmExternalSkillsModal() {
      const confirmBox = document.getElementById('external-skills-confirm');
      if (!confirmBox || !confirmBox.checked) {
        alert('Please confirm overwrite before proceeding.');
        return;
      }
      const choice = document.querySelector('input[name="external_skills_choice"]:checked');
      const value = choice ? choice.value : 'none';

      if (pendingImportMode === 'excel') {
        const targetInput = document.getElementById('external_skills_target');
        if (targetInput) {
          targetInput.value = value;
        }
        closeExternalSkillsModal();
        document.getElementById('excel_file').click();
        return;
      }

      if (pendingImportMode === 'sheet') {
        const payloadInput = document.getElementById('import-sheet-payload');
        if (payloadInput) {
          payloadInput.value = JSON.stringify({ external_skills_target: value });
        }
        closeExternalSkillsModal();
        const form = document.getElementById('import-sheet-form');
        if (form) {
          form.requestSubmit();
        }
        return;
      }
      closeExternalSkillsModal();
    }

    function handleSheetImportClick(event) {
      if (!skillsEnabled) {
        event.preventDefault();
        pendingImportMode = 'sheet';
        openExternalSkillsModal();
      }
    }

    function openExternalSkillsExportModal() {
      const modal = document.getElementById('external-skills-export-modal');
      if (modal) {
        modal.style.display = 'block';
      }
      pauseConfigStatusRefresh(true);
    }

    function closeExternalSkillsExportModal() {
      const modal = document.getElementById('external-skills-export-modal');
      if (modal) {
        modal.style.display = 'none';
      }
      pendingExportMode = null;
      pauseConfigStatusRefresh(false);
    }

    function pauseConfigStatusRefresh(shouldPause) {
      const card = document.getElementById('config-status-card');
      if (!card) {
        return;
      }
      if (shouldPause) {
        if (!card.dataset.originalHxTrigger) {
          card.dataset.originalHxTrigger = card.getAttribute('hx-trigger') || '';
        }
        card.setAttribute('hx-trigger', 'ops-refresh from:body');
      } else if (card.dataset.originalHxTrigger) {
        card.setAttribute('hx-trigger', card.dataset.originalHxTrigger);
      }
    }

    function isExternalModalOpen() {
      const importModal = document.getElementById('external-skills-modal');
      const exportModal = document.getElementById('external-skills-export-modal');
      return (importModal && importModal.style.display === 'block')
        || (exportModal && exportModal.style.display === 'block');
    }

    document.addEventListener('htmx:beforeSwap', function(event) {
      const target = event.detail && event.detail.target;
      if (target && target.id === 'config-status-card' && isExternalModalOpen()) {
        event.detail.shouldSwap = false;
      }
    });

    function confirmExternalSkillsExportModal() {
      const choice = document.querySelector('input[name="external_skills_export_choice"]:checked');
      const value = choice ? choice.value : 'none';

      if (pendingExportMode === 'csv') {
        const link = document.createElement('a');
        link.href = `/api/v1/entries/export-csv?external_skills_target=${encodeURIComponent(value)}`;
        link.download = '';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        closeExternalSkillsExportModal();
        return;
      }

      if (pendingExportMode === 'excel') {
        closeExternalSkillsExportModal();
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = `/api/v1/entries/export-excel-download?external_skills_target=${encodeURIComponent(value)}`;
        document.body.appendChild(iframe);
        setTimeout(() => {
          document.body.removeChild(iframe);
        }, 1000);
        return;
      }

      if (pendingExportMode === 'sheet') {
        const payloadInput = document.getElementById('export-sheet-payload');
        if (payloadInput) {
          payloadInput.value = JSON.stringify({ external_skills_target: value });
        }
        closeExternalSkillsExportModal();
        const form = document.getElementById('export-sheet-form');
        if (form) {
          form.requestSubmit();
        }
        return;
      }

      closeExternalSkillsExportModal();
    }

    function handleSheetExportClick(event) {
      if (!skillsEnabled) {
        event.preventDefault();
        pendingExportMode = 'sheet';
        openExternalSkillsExportModal();
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const sheetButton = document.querySelector('#import-sheet-form button[type="submit"]');
      if (sheetButton) {
        sheetButton.addEventListener('click', handleSheetImportClick);
      }
      const exportSheetButton = document.querySelector('#export-sheet-form button[type="submit"]');
      if (exportSheetButton) {
        exportSheetButton.addEventListener('click', handleSheetExportClick);
      }
    });

    function triggerCsvExportDownload() {
      if (!skillsEnabled) {
        pendingExportMode = 'csv';
        openExternalSkillsExportModal();
        return;
      }
      window.location.href = '/api/v1/entries/export-csv';
    }

    function openExternalSkillsModal() {
      const modal = document.getElementById('external-skills-modal');
      if (modal) {
        modal.style.display = 'block';
      }
      pauseConfigStatusRefresh(true);
    }

    function closeExternalSkillsModal() {
      const modal = document.getElementById('external-skills-modal');
      if (modal) {
        modal.style.display = 'none';
      }
      pendingImportMode = null;
      pauseConfigStatusRefresh(false);
    }

    function confirmExternalSkillsModal() {
      const confirmBox = document.getElementById('external-skills-confirm');
      if (!confirmBox || !confirmBox.checked) {
        alert('Please confirm overwrite before proceeding.');
        return;
      }
      const choice = document.querySelector('input[name="external_skills_choice"]:checked');
      const value = choice ? choice.value : 'none';

      if (pendingImportMode === 'excel') {
        const targetInput = document.getElementById('external_skills_target');
        if (targetInput) {
          targetInput.value = value;
        }
        closeExternalSkillsModal();
        document.getElementById('excel_file').click();
        return;
      }

      if (pendingImportMode === 'sheet') {
        const payloadInput = document.getElementById('import-sheet-payload');
        if (payloadInput) {
          payloadInput.value = JSON.stringify({ external_skills_target: value });
        }
        closeExternalSkillsModal();
        const form = document.getElementById('import-sheet-form');
        if (form) {
          form.requestSubmit();
        }
        return;
      }
      closeExternalSkillsModal();
    }

    function handleSheetImportClick(event) {
      if (!skillsEnabled) {
        event.preventDefault();
        pendingImportMode = 'sheet';
        openExternalSkillsModal();
      }
    }

    function openExternalSkillsExportModal() {
      const modal = document.getElementById('external-skills-export-modal');
      if (modal) {
        modal.style.display = 'block';
      }
      pauseConfigStatusRefresh(true);
    }

    function closeExternalSkillsExportModal() {
      const modal = document.getElementById('external-skills-export-modal');
      if (modal) {
        modal.style.display = 'none';
      }
      pendingExportMode = null;
      pauseConfigStatusRefresh(false);
    }

    function pauseConfigStatusRefresh(shouldPause) {
      const card = document.getElementById('config-status-card');
      if (!card) {
        return;
      }
      if (shouldPause) {
        if (!card.dataset.originalHxTrigger) {
          card.dataset.originalHxTrigger = card.getAttribute('hx-trigger') || '';
        }
        card.setAttribute('hx-trigger', 'ops-refresh from:body');
      } else if (card.dataset.originalHxTrigger) {
        card.setAttribute('hx-trigger', card.dataset.originalHxTrigger);
      }
    }

    function isExternalModalOpen() {
      const importModal = document.getElementById('external-skills-modal');
      const exportModal = document.getElementById('external-skills-export-modal');
      return (importModal && importModal.style.display === 'block')
        || (exportModal && exportModal.style.display === 'block');
    }

    document.addEventListener('htmx:beforeSwap', function(event) {
      const target = event.detail && event.detail.target;
      if (target && target.id === 'config-status-card' && isExternalModalOpen()) {
        event.detail.shouldSwap = false;
      }
    });

    function confirmExternalSkillsExportModal() {
      const choice = document.querySelector('input[name="external_skills_export_choice"]:checked');
      const value = choice ? choice.value : 'none';

      if (pendingExportMode === 'csv') {
        const link = document.createElement('a');
        link.href = `/api/v1/entries/export-csv?external_skills_target=${encodeURIComponent(value)}`;
        link.download = '';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        closeExternalSkillsExportModal();
        return;
      }

      if (pendingExportMode === 'excel') {
        closeExternalSkillsExportModal();
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = `/api/v1/entries/export-excel-download?external_skills_target=${encodeURIComponent(value)}`;
        document.body.appendChild(iframe);
        setTimeout(() => {
          document.body.removeChild(iframe);
        }, 1000);
        return;
      }

      if (pendingExportMode === 'sheet') {
        const payloadInput = document.getElementById('export-sheet-payload');
        if (payloadInput) {
          payloadInput.value = JSON.stringify({ external_skills_target: value });
        }
        closeExternalSkillsExportModal();
        const form = document.getElementById('export-sheet-form');
        if (form) {
          form.requestSubmit();
        }
        return;
      }

      closeExternalSkillsExportModal();
    }

    function handleSheetExportClick(event) {
      if (!skillsEnabled) {
        event.preventDefault();
        pendingExportMode = 'sheet';
        openExternalSkillsExportModal();
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const sheetButton = document.querySelector('#import-sheet-form button[type="submit"]');
      if (sheetButton) {
        sheetButton.addEventListener('click', handleSheetImportClick);
      }
      const exportSheetButton = document.querySelector('#export-sheet-form button[type="submit"]');
      if (exportSheetButton) {
        exportSheetButton.addEventListener('click', handleSheetExportClick);
      }
    });

    function triggerCsvExportDownload() {
      if (!skillsEnabled) {
        pendingExportMode = 'csv';
        openExternalSkillsExportModal();
        return;
      }
      window.location.href = '/api/v1/entries/export-csv';
    }

    function triggerExcelExportAndDownload() {
      if (!skillsEnabled) {
        pendingExportMode = 'excel';
        openExternalSkillsExportModal();
        return;
      }
      if (!skillsEnabled) {
        pendingExportMode = 'excel';
        openExternalSkillsExportModal();
        return;
      }
      // Create a temporary iframe to handle the file download without leaving the page
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = '/api/v1/entries/export-excel-download';
      document.body.appendChild(iframe);

      // Remove the iframe after a short delay
      setTimeout(() => {
        document.body.removeChild(iframe);
      }, 1000);
    }
  </script>
</section>
