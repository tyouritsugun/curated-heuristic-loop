{% set config_status = env_config_status %}
<section
  id="config-status-card"
  class="card"
  hx-get="/ui/settings/config-status"
  hx-trigger="ops-refresh from:body, every 5s"
  hx-target="this"
  hx-swap="outerHTML"
>
  <header>
    <div>
      <h2>Configuration Status</h2>
      <p class="muted">Configuration is managed via <code>.env</code> file. Changes take effect immediately without restart.</p>
    </div>
    <span class="status-pill {{ config_status.state }}">{{ config_status.headline }}</span>
  </header>

  <div class="config-status-grid">
    <div class="config-section">
      {% set import_summary = ((job_summaries or {}).get('import') or {}) %}
      {% set import_active = import_summary.get('is_active', False) %}
      <div class="section-header">
        <form hx-post="/ui/operations/run/import" hx-target="#config-status-card" hx-swap="outerHTML" style="margin: 0;">
          <button type="submit" class="section-title-button" {% if import_active %}disabled{% endif %}>
            {% if import_active %}
              Import Spreadsheet (Importing...)
            {% else %}
              Import Spreadsheet
            {% endif %}
          </button>
        </form>
      </div>
      {% if config_status.import_sheet_id %}
        {% set summary = import_summary %}
        {% if summary %}
          <div class="status-row">
            <div>
              <p class="run-label">Last Run</p>
              <p class="muted">{{ summary.description or 'Activity recorded.' }}</p>
            </div>
            <span class="status-pill {{ summary.pill_class }}" data-job-status="{{ summary.status }}">
              {{ summary.status_label }}
            </span>
          </div>
        {% else %}
          <div class="status-row">
            <span class="status-chip ok">Configured</span>
            <small class="muted">No runs yet</small>
          </div>
        {% endif %}
      {% else %}
        <div class="status-row">
          <span class="status-chip error">Not Configured</span>
          <small class="muted">Set IMPORT_SPREADSHEET_ID in .env file</small>
        </div>
      {% endif %}
    </div>

    <div class="config-section">
      {% set export_summary = ((job_summaries or {}).get('export') or {}) %}
      {% set export_active = export_summary.get('is_active', False) %}
      <div class="section-header">
        <form hx-post="/ui/operations/run/export" hx-target="#config-status-card" hx-swap="outerHTML" style="margin: 0;">
          <button type="submit" class="section-title-button" {% if export_active %}disabled{% endif %}>
            {% if export_active %}
              Export Spreadsheet (Exporting...)
            {% else %}
              Export Spreadsheet
            {% endif %}
          </button>
        </form>
      </div>
      {% if config_status.export_sheet_id %}
        {% set summary = export_summary %}
        {% if summary %}
          <div class="status-row">
            <div>
              <p class="run-label">Last Run</p>
              <p class="muted">{{ summary.description or 'Activity recorded.' }}</p>
            </div>
            <span class="status-pill {{ summary.pill_class }}" data-job-status="{{ summary.status }}">
              {{ summary.status_label }}
            </span>
          </div>
        {% else %}
          <div class="status-row">
            <span class="status-chip ok">Configured</span>
            <small class="muted">No runs yet</small>
          </div>
        {% endif %}
      {% else %}
        <div class="status-row">
          <span class="status-chip error">Not Configured</span>
          <small class="muted">Set EXPORT_SPREADSHEET_ID in .env file</small>
        </div>
      {% endif %}

      <div class="section-header" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color, #e0e0e0);">
        <button type="button" class="section-title-button" style="width: 100%; cursor: pointer;" onclick="(function(){const a=document.createElement('a');a.href='/api/v1/entries/export-csv';a.download='';a.style.display='none';document.body.appendChild(a);a.click();document.body.removeChild(a);})()">
          Export CSV
        </button>
      </div>
      <div class="status-row">
        <span class="status-chip ok">Team Curation</span>
        <small class="muted">Downloads {username}.zip for merge workflow</small>
      </div>
    </div>
  </div>

  {% if is_partial and (message or error) %}
    {% with oob=True %}
      {% include "common/partials/flash.html" %}
    {% endwith %}
  {% endif %}
</section>
