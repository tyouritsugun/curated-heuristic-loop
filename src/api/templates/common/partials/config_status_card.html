{% set config_status = env_config_status %}
<section
  id="config-status-card"
  class="card"
  hx-get="/ui/settings/config-status"
  hx-trigger="ops-refresh from:body, every 5s"
  hx-target="this"
  hx-swap="outerHTML"
>
  <header>
    <div>
      <h2>Configuration Status</h2>
      <p class="muted">Configuration is managed via <code>.env</code> file. Changes take effect immediately without restart.</p>
      {% if skills_enabled is not none and not skills_enabled %}
        <p class="muted" style="margin-top: 0.5rem;">
          <strong>Skills are disabled.</strong> Skill read/write/import/export are hidden or skipped.
        </p>
      {% endif %}
    </div>
    <span class="status-pill {{ config_status.state }}">{{ config_status.headline }}</span>
  </header>

  <div class="config-status-grid">
    <div class="config-section">
      {% set import_summary = ((job_summaries or {}).get('import') or {}) %}
      {% set import_active = import_summary.get('is_active', False) %}
      <div class="section-header">
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding-right: 0.5rem; width: 50%;">
              <form hx-post="/ui/operations/run/import" hx-target="#config-status-card" hx-swap="outerHTML" style="margin: 0;">
                <button type="submit" class="section-title-button" style="width: 90%;" {% if import_active %}disabled{% endif %}>
                  {% if import_active %}
                    Import Spreadsheet (Importing...)
                  {% else %}
                    Import Spreadsheet
                  {% endif %}
                </button>
              </form>
            </td>
            <td style="padding-left: 0.5rem; width: 50%;">
              <form id="import-excel-form" action="/ui/operations/import-excel-upload" method="post" enctype="multipart/form-data" style="margin: 0; display: none;">
                <input type="file" name="excel_file" id="excel_file" accept=".xlsx,.xls" onchange="handleExcelFileSelect(this)" />
              </form>
              <button type="button" class="section-title-button" style="width: 100%;" onclick="triggerExcelFileSelect()">Import Excel</button>
            </td>
          </tr>
        </table>
      </div>
      {% if config_status.import_sheet_id %}
        {% set summary = import_summary %}
        {% if summary %}
          <div class="status-row">
            <div>
              <p class="run-label">Last Run</p>
              <p class="muted">{{ summary.description or 'Activity recorded.' }}</p>
            </div>
            <span class="status-pill {{ summary.pill_class }}" data-job-status="{{ summary.status }}">
              {{ summary.status_label }}
            </span>
          </div>
        {% else %}
          <div class="status-row">
            <span class="status-chip ok">Configured</span>
            <small class="muted">No runs yet</small>
          </div>
        {% endif %}
      {% else %}
        <div class="status-row">
          <span class="status-chip error">Not Configured</span>
          <small class="muted">Set IMPORT_SPREADSHEET_ID in .env file</small>
        </div>
      {% endif %}
    </div>

    <div class="config-section">
      {% set export_summary = ((job_summaries or {}).get('export') or {}) %}
      {% set export_active = export_summary.get('is_active', False) %}
      <div class="section-header">
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding-right: 0.5rem; width: 50%;">
              <form hx-post="/ui/operations/run/export" hx-target="#config-status-card" hx-swap="outerHTML" style="margin: 0;">
                <button type="submit" class="section-title-button" style="width: 90%;" {% if export_active %}disabled{% endif %}>
                  {% if export_active %}
                    Export Spreadsheet (Exporting...)
                  {% else %}
                    Export Spreadsheet
                  {% endif %}
                </button>
              </form>
            </td>
            <td style="padding-left: 0.5rem; width: 50%;">
              <button type="button" class="section-title-button" style="width: 100%;" onclick="triggerExcelExportAndDownload()">Export Excel</button>
            </td>
          </tr>
        </table>
      </div>
      {% if config_status.export_sheet_id %}
        {% set summary = export_summary %}
        {% if summary %}
          <div class="status-row">
            <div>
              <p class="run-label">Last Run</p>
              <p class="muted">{{ summary.description or 'Activity recorded.' }}</p>
            </div>
            <span class="status-pill {{ summary.pill_class }}" data-job-status="{{ summary.status }}">
              {{ summary.status_label }}
            </span>
          </div>
        {% else %}
          <div class="status-row">
            <span class="status-chip ok">Configured</span>
            <small class="muted">No runs yet</small>
          </div>
        {% endif %}
      {% else %}
        <div class="status-row">
          <span class="status-chip error">Not Configured</span>
          <small class="muted">Set EXPORT_SPREADSHEET_ID in .env file</small>
        </div>
      {% endif %}

      <div class="section-header" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color, #e0e0e0);">
        <button type="button" class="section-title-button" style="width: 100%; cursor: pointer;" onclick="(function(){const a=document.createElement('a');a.href='/api/v1/entries/export-csv';a.download='';a.style.display='none';document.body.appendChild(a);a.click();document.body.removeChild(a);})()">
          Export CSV
        </button>
      </div>
      <div class="status-row">
        <span class="status-chip ok">Team Curation</span>
        <small class="muted">Downloads {username}_export.zip for merge workflow</small>
      </div>
    </div>
  </div>

  {% if skills_enabled %}
    <div class="config-status-grid" style="margin-top: 1.5rem;">
      <div class="config-section">
        <div class="section-header">
          <h3 style="margin: 0;">External Skills (Claude/Codex)</h3>
          <p class="muted" style="margin: 0.25rem 0 0;">Default paths: <code>~/.claude/skills</code>, <code>~/.codex/skills</code></p>
          <p class="muted" style="margin: 0.25rem 0 0;">SKILL.md must include YAML frontmatter with <code>name</code> and <code>description</code>.</p>
        </div>
        <div class="section-header" style="margin-top: 0.75rem;">
          <table style="width: 100%; border-collapse: collapse;">
            <tr>
              <td style="padding-right: 0.5rem; width: 50%;">
                <form hx-post="/ui/operations/run/import-claude" hx-target="#config-status-card" hx-swap="outerHTML" style="margin: 0;">
                  <button type="submit" class="section-title-button" style="width: 100%;">Import Claude SKILL.md</button>
                </form>
              </td>
              <td style="padding-left: 0.5rem; width: 50%;">
                <form hx-post="/ui/operations/run/export-claude" hx-target="#config-status-card" hx-swap="outerHTML" style="margin: 0;">
                  <button type="submit" class="section-title-button" style="width: 100%;">Export Claude SKILL.md</button>
                </form>
              </td>
            </tr>
            <tr>
              <td style="padding-right: 0.5rem; padding-top: 0.5rem; width: 50%;">
                <form hx-post="/ui/operations/run/import-codex" hx-target="#config-status-card" hx-swap="outerHTML" style="margin: 0;">
                  <button type="submit" class="section-title-button" style="width: 100%;">Import Codex Skills</button>
                </form>
              </td>
              <td style="padding-left: 0.5rem; padding-top: 0.5rem; width: 50%;">
                <form hx-post="/ui/operations/run/export-codex" hx-target="#config-status-card" hx-swap="outerHTML" style="margin: 0;">
                  <button type="submit" class="section-title-button" style="width: 100%;">Export Codex Skills</button>
                </form>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  {% endif %}

  {% if is_partial and (message or error) %}
    {% with oob=True %}
      {% include "common/partials/flash.html" %}
    {% endwith %}
  {% endif %}

  <script>
    function triggerExcelFileSelect() {
      document.getElementById('excel_file').click();
    }

    function handleExcelImport(event) {
      event.preventDefault();
      const form = document.getElementById('import-excel-form');
      const fileInput = document.getElementById('excel_file');

      // Submit the form normally (not via HTMX since it has file upload)
      const formData = new FormData(form);

      // Debug logging
      console.log('Submitting Excel file:', fileInput.files[0] ? fileInput.files[0].name : 'No file');

      fetch(form.action, {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.text();
      })
      .then(html => {
        console.log('Received response from server, updating UI');
        // Replace the config-status-card with the updated content
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newCard = doc.querySelector('#config-status-card');
        if (newCard) {
          document.getElementById('config-status-card').outerHTML = newCard.outerHTML;
        } else {
          console.error('Could not find config-status-card in response');
        }
      })
      .catch(error => {
        console.error('Error importing Excel:', error);
        alert('Error importing Excel file: ' + error.message);
      });
    }

    function handleExcelFileSelect(inputElement) {
      if (inputElement.files.length > 0) {
        // Pass a mock event to handleExcelImport to prevent default
        const mockEvent = { preventDefault: function() {} };
        handleExcelImport(mockEvent);
      }
    }

    function triggerExcelExportAndDownload() {
      // Create a temporary iframe to handle the file download without leaving the page
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = '/api/v1/entries/export-excel-download';
      document.body.appendChild(iframe);

      // Remove the iframe after a short delay
      setTimeout(() => {
        document.body.removeChild(iframe);
      }, 1000);
    }
  </script>
</section>
