<section
  id="diagnostics-panel"
  class="card diagnostics"
  hx-get="/ui/settings/diagnostics"
  {% if not is_partial %}hx-trigger="revealed once, settings-changed from:body"{% endif %}
  hx-target="#diagnostics-panel"
  hx-swap="outerHTML"
>
  <header>
    <div>
      <h2>Connectivity &amp; Validation</h2>
      <p class="muted">Checks credential readability, sheet metadata, and model overrides.</p>
    </div>
    <form
      method="post"
      action="/ui/settings/diagnostics"
      hx-post="/ui/settings/diagnostics"
      hx-target="#diagnostics-panel"
      hx-swap="outerHTML"
      hx-indicator="#diagnostics-indicator"
    >
      <button type="submit" class="secondary">Test Connectivity</button>
    </form>
  </header>
  <ul class="diag-grid">
    {% for name, status in diagnostics.items() %}
      <li class="diag-row {{ status.state }}">
        <div class="diag-main">
          <span class="status-dot"></span>
          <div>
            <p class="diag-title">{{ status.headline }}</p>
            <p class="diag-detail">{{ status.detail or "" }}</p>
          </div>
        </div>
        <small class="diag-timestamp" data-utc="{{ status.validated_at }}">{{ status.validated_at or "n/a" }}</small>
      </li>
    {% endfor %}
  </ul>
  <span class="htmx-indicator" id="diagnostics-indicator">Checkingâ€¦</span>
</section>

{% if is_partial %}
  <span class="htmx-indicator" id="diagnostics-indicator" hx-swap-oob="true"></span>
  {% if message or error %}
    {% with oob=True %}
      {% include "common/partials/flash.html" %}
    {% endwith %}
  {% endif %}
{% else %}
  {% if message or error %}
    {% with oob=True %}
      {% include "common/partials/flash.html" %}
    {% endwith %}
  {% endif %}
{% endif %}
