{# Prefer live queue depth from worker_status; fall back to last telemetry sample #}
{% set queue_sample = (worker_status.get('queue') if worker_status else None) or (snapshot.queue.value if snapshot and snapshot.queue else None) %}
{% set pending = queue_sample.get('pending') if queue_sample else {'total': 0, 'experiences': 0, 'manuals': 0} %}
{% set processing = queue_sample.get('processing') if queue_sample else {'total': 0, 'experiences': 0, 'manuals': 0} %}
{% set queued_total = pending.get('total', 0) + processing.get('total', 0) %}
{% set queued_exp = pending.get('experiences', 0) + processing.get('experiences', 0) %}
{% set queued_man = pending.get('manuals', 0) + processing.get('manuals', 0) %}
{% set failed = queue_sample.get('failed') if queue_sample else {'total': 0, 'experiences': 0, 'manuals': 0} %}
{% set pending_total = pending.get('total', 0) %}
{% set pending_exp = pending.get('experiences', 0) %}
{% set pending_man = pending.get('manuals', 0) %}
{% set failed_total = failed.get('total', 0) %}
{% set failed_exp = failed.get('experiences', 0) %}
{% set failed_man = failed.get('manuals', 0) %}
<section
  id="ops-queue-card"
  class="card ops-card"
  hx-get="/ui/operations/queue"
  hx-trigger="ops-refresh from:body, sse:queue, every 1s"
  hx-target="this"
  hx-swap="outerHTML"
>
  <header>
    <div>
      <h2>Queue Health</h2>
      <p class="muted">Live DB counts (pending + in-progress).</p>
    </div>
    <span class="status-pill {{ 'ok' if queued_total == 0 else 'warn' }}">
      {{ 'Idle' if queued_total == 0 else queued_total ~ ' queued' }}
    </span>
  </header>
  <div class="stat-grid">
    <div class="stat-pair">
      <p class="stat-label">Queued (pending+processing)</p>
      <p class="stat-value">{{ queued_total }}<small class="muted"> ({{ queued_exp }}/{{ queued_man }})</small></p>
    </div>
    <div class="stat-pair">
      <p class="stat-label">In Progress (exp/manuals)</p>
      <p class="stat-value">{{ processing.get('total', 0) }}<small class="muted"> ({{ processing.get('experiences', 0) }}/{{ processing.get('manuals', 0) }})</small></p>
    </div>
    <div class="stat-pair">
      <p class="stat-label">Failed (exp/manuals)</p>
      <p class="stat-value">{{ failed_total }}<small class="muted"> ({{ failed_exp }}/{{ failed_man }})</small></p>
    </div>
    <div class="stat-pair">
      <p class="stat-label">Sync Status</p>
      {% set sync_summary = ((job_summaries or {}).get('sync-embeddings') or (job_summaries or {}).get('sync')) %}
      {% if sync_summary %}
        <p class="stat-value" style="font-size: 0.9rem;">
          <span class="status-pill {{ sync_summary.pill_class }}" data-job-status="{{ sync_summary.status }}" style="font-size: 0.75rem; padding: 0.25rem 0.6rem;">
            {{ sync_summary.status_label }}
          </span>
        </p>
      {% else %}
        <p class="stat-value" style="font-size: 0.9rem;">No runs yet</p>
      {% endif %}
    </div>
  </div>
  <span class="htmx-indicator">Refreshingâ€¦</span>
</section>
{% if is_partial and (message or error) %}
  {% with oob=True %}
    {% include "common/partials/flash.html" %}
  {% endwith %}
{% endif %}
