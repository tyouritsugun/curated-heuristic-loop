<section
  id="ops-controls-card"
  class="card ops-card"
  hx-get="/ui/operations/controls"
  hx-trigger="ops-refresh from:body, every 3s"
  hx-target="this"
  hx-swap="outerHTML"
  sse-swap="controls"
>
  <header>
    <div>
      <h2>Operations</h2>
      <p class="muted">Trigger import/export jobs with advisory locks. Embeddings sync automatically after import.</p>
    </div>
  </header>
  <div class="ops-actions">
    {# Guard against None summaries to avoid calling .get on None #}
    {% set import_summary = ((job_summaries or {}).get('import') or {}) %}
    {% set export_summary = ((job_summaries or {}).get('export') or {}) %}
    {% set import_active = import_summary.get('is_active', False) %}
    {% set export_active = export_summary.get('is_active', False) %}
    <form hx-post="/ui/operations/run/import" hx-target="#ops-controls-card" hx-swap="outerHTML">
      <button type="submit" {% if import_active %}disabled{% endif %}>Run Import</button>
    </form>
    <form hx-post="/ui/operations/run/export" hx-target="#ops-controls-card" hx-swap="outerHTML">
      <button type="submit" class="secondary" {% if export_active %}disabled{% endif %}>Run Export</button>
    </form>
  </div>
  <small class="muted">Buttons disable automatically if a job already holds the lock.</small>
  <small class="muted caution-text">Import expects the target Google Sheet to already have <em>Categories</em>, <em>Experiences</em>, and <em>Manuals</em> worksheets. Export clears those worksheets before writing fresh rows from <code>data/chl.db</code>. After import, embeddings are generated and the search index is rebuilt automatically.</small>
  <div class="ops-last-run">
    {% set ordered = ['import', 'export', 'sync'] %}
    {% for job_type in ordered %}
      {% set summary = (job_summaries or {}).get(job_type) %}
      <div class="run-row" data-job-type="{{ job_type }}">
        <div>
          <p class="run-label">{{ job_type|capitalize }}</p>
          {% if summary %}
            <p class="muted">{{ summary.description or 'Activity recorded.' }}</p>
          {% else %}
            <p class="muted">No runs yet.</p>
          {% endif %}
        </div>
        {% if summary %}
          <span class="status-pill {{ summary.pill_class }}" data-job-status="{{ summary.status }}">
            {{ summary.status_label }}
          </span>
        {% endif %}
      </div>
    {% endfor %}
  </div>
  <span class="htmx-indicator">Schedulingâ€¦</span>
</section>
{% if is_partial and (message or error) %}
  {% with oob=True %}
    {% include "partials/flash.html" %}
  {% endwith %}
{% endif %}
