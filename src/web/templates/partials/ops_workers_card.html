{% set pool = snapshot.worker_pool.value if snapshot.worker_pool else (worker_status.workers if worker_status else {}) %}
{% set workers = snapshot.workers if snapshot.workers else [] %}
<section
  id="ops-workers-card"
  class="card ops-card"
  hx-get="/ui/operations/workers"
  hx-trigger="load, ops-refresh from:body"
  hx-target="this"
  hx-swap="outerHTML"
  sse-swap="workers"
>
  <header>
    <div>
      <h2>Worker Control</h2>
      <p class="muted">Pause, resume, or drain embedding workers.</p>
    </div>
    <span class="status-pill {{ 'ok' if workers else 'warn' }}">{{ 'Online' if workers else 'Offline' }}</span>
  </header>
  {% if workers %}
    <div class="ops-actions">
      <form hx-post="/ui/workers/pause" hx-target="#ops-workers-card" hx-swap="outerHTML">
        <button type="submit" class="secondary">Pause</button>
      </form>
      <form hx-post="/ui/workers/resume" hx-target="#ops-workers-card" hx-swap="outerHTML">
        <button type="submit">Resume</button>
      </form>
      <form hx-post="/ui/workers/drain" hx-target="#ops-workers-card" hx-swap="outerHTML">
        <label>
          Drain timeout (s)
          <input type="number" name="timeout" value="300" min="10" max="3600" />
        </label>
        <button type="submit">Drain Queue</button>
      </form>
    </div>
  {% else %}
    <div class="ops-actions muted">
      Background workers are not configured in this build. Use the FAISS snapshot tools to refresh vectors manually.
    </div>
  {% endif %}

  <table class="job-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Status</th>
        <th>Processed</th>
        <th>Failed</th>
        <th>Heartbeat</th>
      </tr>
    </thead>
    <tbody>
      {% if workers %}
        {% for worker in workers %}
          <tr>
            <td>{{ worker.worker_id }}</td>
            <td>{{ worker.status }}</td>
            <td>{{ worker.processed }}</td>
            <td>{{ worker.failed }}</td>
            <td>{{ worker.heartbeat_at }}</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="5" class="muted">No workers reporting. This is expected unless you deploy an external embedding service.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
  <span class="htmx-indicator">Updating workersâ€¦</span>
</section>
{% if is_partial and (message or error) %}
  {% with oob=True %}
    {% include "partials/flash.html" %}
  {% endwith %}
{% endif %}
