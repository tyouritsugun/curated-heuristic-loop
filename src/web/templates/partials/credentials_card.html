{% set credentials = snapshot.credentials %}
{% set cred_diag = diagnostics.credentials %}
<section id="credentials-card" class="card">
  <header>
    <div>
      <h2>Credentials</h2>
      <p class="muted">Secrets stay on disk under <code>{{ managed_credentials_dir }}</code>.</p>
    </div>
    <span class="status-pill {{ cred_diag.state }}">{{ cred_diag.headline }}</span>
  </header>

  <p>Upload the Google service-account JSON into the managed directory or point to an existing readable path. Only the path, checksum, and validation timestamp are stored.</p>

  <details open>
    <summary>Upload to this machine</summary>
    <form
      method="post"
      action="/ui/settings/credentials/upload"
      enctype="multipart/form-data"
      hx-post="/ui/settings/credentials/upload"
      hx-target="#credentials-card"
      hx-swap="outerHTML"
      hx-indicator="#credentials-indicator"
    >
      <label>
        Select credential JSON
        <input type="file" name="credential_file" accept="application/json" required />
      </label>
      <label>
        Notes (optional)
        <input type="text" name="notes" placeholder="e.g., Rotated 2025-11-07" />
      </label>
      <button type="submit">Upload &amp; Validate</button>
    </form>
  </details>

  <details>
    <summary>Use existing file (advanced)</summary>
    <form
      method="post"
      action="/ui/settings/credentials/path"
      hx-post="/ui/settings/credentials/path"
      hx-target="#credentials-card"
      hx-swap="outerHTML"
      hx-indicator="#credentials-indicator"
    >
      <label>
        Absolute or managed-relative path
        <input type="text" name="path" value="{{ credentials.path if credentials else '' }}" placeholder="/path/to/credentials.json" required />
      </label>
      <label>
        Notes (optional)
        <input type="text" name="notes" placeholder="Visible in audit log" />
      </label>
      <button type="submit" class="secondary">Use Existing File</button>
    </form>
    <small class="muted">Browser paths are not accessible to the server. Place the file where this process can read it (SSH, shared volume, etc.).</small>
  </details>

  <div class="meta-grid">
    <div>
      <p class="meta-label">Current file</p>
      <p class="meta-value">{{ credentials.path if credentials else 'n/a' }}</p>
    </div>
    <div>
      <p class="meta-label">Checksum</p>
      <p class="meta-value">{{ credentials.checksum[:12] ~ '…' if credentials and credentials.checksum else 'n/a' }}</p>
    </div>
    <div>
      <p class="meta-label">Validated</p>
      <p class="meta-value">{{ credentials.validated_at or 'n/a' if credentials else 'n/a' }}</p>
    </div>
  </div>

  <span class="htmx-indicator" id="credentials-indicator">Validating…</span>

  {% if is_partial and (message or error) %}
    {% with oob=True %}
      {% include "partials/flash.html" %}
    {% endwith %}
  {% endif %}
</section>
