{% extends "base.html" %}
{% block content %}
  <header class="page-header">
    <div>
      <h1>Operations &amp; Monitoring</h1>
      <p class="muted">Trigger imports/exports, watch worker status, and monitor queue health in real time.</p>
    </div>
    <div class="actions">
      <a class="secondary" href="/settings">View Settings</a>
      <span id="sse-conn-indicator" class="status-pill info" aria-live="polite" title="Server-Sent Events connection status">Connecting…</span>
    </div>
  </header>

  {% include "partials/flash.html" %}
  {% include "partials/ops_onboarding.html" %}

  {% set cred_diag = diagnostics.credentials %}
  {% if cred_diag.state != 'ok' %}
    <article class="ops-status-alert">
      <strong>Action required:</strong> {{ cred_diag.headline }} — {{ cred_diag.detail }}.
      <a href="/settings">Update credentials</a>
    </article>
  {% endif %}

  <div class="ops-grid" hx-ext="sse" sse-connect="/ui/stream/telemetry">
    {% include "partials/ops_operations_card.html" %}
    {% include "partials/ops_index_card.html" %}
    {% include "partials/ops_workers_card.html" %}
    {% include "partials/ops_queue_card.html" %}
    <div class="full-span">
      {% include "partials/ops_jobs_card.html" %}
    </div>
  </div>
  <script>
    (function() {
      function setSseState(cls, text) {
        var el = document.getElementById('sse-conn-indicator');
        if (!el) return;
        el.classList.remove('ok','warn','error','info');
        el.classList.add(cls);
        el.textContent = text;
      }

      // Prefer events from the SSE extension if available
      document.body.addEventListener('htmx:sseOpen', function () {
        setSseState('ok', 'Live');
      });
      document.body.addEventListener('htmx:sseReconnect', function () {
        setSseState('warn', 'Reconnecting…');
      });
      document.body.addEventListener('htmx:sseError', function () {
        setSseState('warn', 'Reconnecting…');
      });
      document.body.addEventListener('htmx:sseClose', function () {
        setSseState('error', 'Disconnected');
      });
    })();
  </script>
{% endblock %}
